name: Run Semgrep in Minikube

on:
  issues:
    types: [opened, edited]

jobs:
  debug-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Issue Information
        run: |
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Labels: ${{ toJson(github.event.issue.labels) }}"
          echo "Issue Body: ${{ github.event.issue.body }}"
          echo "Condition Check - Title contains '[Semgrep Minikube]': ${{ contains(github.event.issue.title, '[Semgrep Minikube]') }}"
          echo "Condition Check - Has 'semgrep' label: ${{ contains(github.event.issue.labels.*.name, 'semgrep') }}"
          echo "Condition Check - Has 'minikube' label: ${{ contains(github.event.issue.labels.*.name, 'minikube') }}"

  run-semgrep-minikube:
    if: contains(github.event.issue.title, '[Semgrep Minikube]') || (contains(github.event.issue.labels.*.name, 'semgrep') && contains(github.event.issue.labels.*.name, 'minikube'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Comment on Issue - Starting Deployment
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ **Semgrep Minikube Deployment Started**\n\nâš ï¸ **Note**: Based on your preferences, this workflow is configured for local Minikube deployment. Please ensure your local Minikube cluster is running.\n\nFor local deployment, please run the following commands on your local machine:\n\n```bash\n# Ensure Minikube is running\nminikube status\n\n# Deploy Semgrep job\nhelm upgrade --install semgrep-job ./k8s-jobs --values ./environments/dev/values.yaml\n```\n\nThis GitHub Actions workflow will prepare the deployment configuration but won\'t actually deploy to your local cluster.'
            })

      - name: Extract Environment from Issue
        id: extract-env
        run: |
          # Extract environment from issue body
          ENV=$(echo '${{ github.event.issue.body }}' | grep -i "target environment" -A 3 | grep -E "(dev|beta|prod)" -o | head -1 || echo "dev")
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Selected environment: $ENV"

      - name: Validate Environment Configuration
        run: |
          ENV="${{ steps.extract-env.outputs.environment }}"
          if [ -f "./environments/$ENV/values.yaml" ]; then
            echo "âœ… Environment configuration found: ./environments/$ENV/values.yaml"
            cat "./environments/$ENV/values.yaml"
          else
            echo "âŒ Environment configuration not found for: $ENV"
            echo "Available environments:"
            ls -la ./environments/
            exit 1
          fi

      - name: Prepare Deployment Instructions
        run: |
          ENV="${{ steps.extract-env.outputs.environment }}"
          echo "## ðŸ“‹ Local Minikube Deployment Instructions" > deployment-instructions.md
          echo "" >> deployment-instructions.md
          echo "Based on your issue, here are the commands to run on your local machine:" >> deployment-instructions.md
          echo "" >> deployment-instructions.md
          echo "\`\`\`bash" >> deployment-instructions.md
          echo "# 1. Ensure Minikube is running" >> deployment-instructions.md
          echo "minikube status" >> deployment-instructions.md
          echo "" >> deployment-instructions.md
          echo "# 2. Deploy Semgrep job with $ENV environment" >> deployment-instructions.md
          echo "helm upgrade --install semgrep-job ./k8s-jobs \\" >> deployment-instructions.md
          echo "  --values ./environments/$ENV/values.yaml" >> deployment-instructions.md
          echo "" >> deployment-instructions.md
          echo "# 3. Check deployment status" >> deployment-instructions.md
          echo "kubectl get pods" >> deployment-instructions.md
          echo "kubectl get jobs" >> deployment-instructions.md
          echo "" >> deployment-instructions.md
          echo "# 4. View Semgrep results" >> deployment-instructions.md
          echo "kubectl logs job/semgrep-job" >> deployment-instructions.md
          echo "\`\`\`" >> deployment-instructions.md

      - name: Comment Deployment Instructions
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const instructions = fs.readFileSync('deployment-instructions.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: instructions
            })